# Template file for 'pulse-secure'
pkgname=pulse-secure
version=9.1r9.0
_rev=b255
revision=1
wrksrc=pulse
only_for_archs="x86_64"
makedepends="rpmextract tar"
depends="libgcc libgnome-keyring webkit2gtk"
short_desc="Pulse Connect Secure (PCS) Client"
maintainer="Brandon Martin <brandon@codedmart.com>"
license="custom"
homepage="https://www.pulsesecure.net/"
repository=nonfree
restricted=yes
distfiles="http://webdev.web3.technion.ac.il/docs/cis/public/ssl-vpn/v.9.1R9.0/ps-pulse-linux-${version}-${_rev}-centos-rhel-64-bit-installer.rpm"
checksum=af60e99946e16c55ae0e37759968a3b175aadcd3f2d3954e2c120403df65e3de
nopie=yes

do_extract() {
  rpmextract ${XBPS_SRCDISTDIR}/${pkgname}-${version}/ps-pulse-linux-${version}-${_rev}-centos-rhel-64-bit-installer.rpm

  patch -Np0 -i ${FILESDIR}/PulseClient-Void.patch

  tar -zxvf ${XBPS_BUILDDIR}/pulse/usr/local/pulse/pulse.tgz
}

# adapted from ConfigurePulse_x86_64.sh
update_build_info() {
  BUILD_VERSION=${version}
  BUILD_NUMBER=${revision}

  sed -i "s/BUILD_VERSION/${BUILD_VERSION}/g" "${PKGDESTDIR}/usr/share/pulse/html/about.html"
  sed -i "s/BUILD_NUMBER/${BUILD_NUMBER}/g" "${PKGDESTDIR}/usr/share/pulse/html/about.html"
}

do_install() {

  vinstall ${XBPS_BUILDDIR}/pulse/usr/local/pulse/PulseClient_x86_64.sh 755 usr/share/pulse
  vinstall ${XBPS_BUILDDIR}/pulse/usr/local/pulse/README 644 usr/share/pulse
  vinstall ${XBPS_BUILDDIR}/pulse/usr/local/pulse/version.txt 644 usr/share/pulse
  vinstall ${XBPS_BUILDDIR}/pulse/pulseutil 755 usr/libexec/pulse
  vinstall ${XBPS_BUILDDIR}/pulse/pulsesvc 4755 usr/libexec/pulse
  vinstall ${XBPS_BUILDDIR}/pulse/pulseUi_centos_7_x86_64 755 usr/libexec/pulse pulseUi
  vinstall ${XBPS_BUILDDIR}/pulse/libpulseui.so_centos_7_x86_64 755 usr/lib/pulse libpulseui.so
  vinstall ${XBPS_BUILDDIR}/pulse/pulseUi.desktop 644 usr/share/applications

  # Wrappers & symlinks
  vinstall ${FILESDIR}/pulseUi.sh 755 usr/bin pulseUi
  ln -s ${PKGDESTDIR}/usr/libexec/pulse/pulsesvc ${PKGDESTDIR}/usr/bin/pulsesvc

  vcopy ${XBPS_BUILDDIR}/pulse/html usr/share/pulse/html

  vinstall ${FILESDIR}/EULA.txt 644 usr/share/licenses/${pkgname}/EULA.txt

  find ${PKGDESTDIR} -type f -exec sed -i 's/\/usr\/local/\/usr\/share/g' {} \;

  update_build_info
}

